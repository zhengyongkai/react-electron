name: Detect direct push to main

on:
  push:
    branches:
      - main

jobs:
  detect-direct-push:
    name: Detect direct push and create issue
    runs-on: ubuntu-latest
    steps:
      - name: Check if this push is associated with a Pull Request
        id: check_pr
        uses: actions/github-script@v6
        with:
          script: |
            const commitSha = process.env.GITHUB_SHA;
            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: commitSha
            });
            core.setOutput('is_pr_merge', prs && prs.length > 0 ? 'true' : 'false');
      - name: Create an issue for direct push
        if: steps.check_pr.outputs.is_pr_merge == 'false'
        uses: peter-evans/create-issue@v4
        with:
          title: "Direct push to main detected"
          labels: "direct-push,security"
          body: |
            A direct push to `main` was detected.

            - Repository: ${{ github.repository }}
            - Pusher: ${{ github.actor }}
            - Commit: ${{ github.sha }}
            - Compare URL: ${{ github.event.compare }}

            Commits in this push:
            ${{ toJSON(github.event.commits) }}

            Please review the branch protection rules and revert the changes if they should not be on `main`.

      - name: Log that this push looks like a PR merge (no action)
        if: steps.check_pr.outputs.is_pr_merge == 'true'
        run: echo "Push is associated with a PR; no issue created."
